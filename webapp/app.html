<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

    <!-- https://getbootstrap.com/docs/3.4/customize/ -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">

<style>
#lamps {
    margin: 0px;
    padding: 0px;
}

.lamp_li {
    list-style-type: none;
    border: 1px black solid;
    width: 100%;
    padding-top: 6px;
    padding-bottom: 6px;
}

.lamp_is_on_checkbox {
    width: 40px;
    margin: 0;
    padding: 0:
}

.lamp_open_panel_ctrl {
    /*display: inline-block;*/
    width: 150px;
    margin: 0;
    padding: 0:
}

.lamp_set_brightness_slider {
    margin: 0;
    padding: 0:
}

@media (min-width: 600px) {
    /* Big screens: show brightness slider inline. Small screens: show slider
       in own line, to give user more space */
    .lamp_set_brightness_slider {
        /* !important overrides bootstrap styles */
        vertical-align:middle !important;
        width: calc(100% - 200px) !important;
        display: inline-block !important;
        float: right;
    }
}

/*********************************/

#networkstatus {
}

#networkstatus td {
    border: 1px black solid;
}
</style>

<script>
JSON.stringify = JSON.stringify || function (obj) {
    var t = typeof (obj);
    if (t != "object" || obj === null) {
        // simple data type
        if (t == "string") obj = '"'+obj+'"';
        return String(obj);
    }
    else {
        // recurse array or object
        var n, v, json = [], arr = (obj && obj.constructor == Array);
        for (n in obj) {
            v = obj[n]; t = typeof(v);
            if (t == "string") v = '"'+v+'"';
            else if (t == "object" && v !== null) v = JSON.stringify(v);
            json.push((arr ? "" : '"' + n + '":') + String(v));
        }
        return (arr ? "[" : "{") + String(json) + (arr ? "]" : "}");
    }
};

var wget = function(url) {
    var d = $.Deferred();
    $.ajax({
      type: 'GET',
      dataType: 'json',
      url: url,
      success: function(msg){ d.resolve(msg); },
      error: function(request, server_status, error){ d.resolve(null); },
    });
    return d;
}

class Lamp {
    constructor(things_server_url, name, supported_actions, status) {
        this.action_base_url = things_server_url + 'things/' + name;
        this.name = name;
        // HTML ids can't contain whitespaces
        this.html_id = name.split(' ').join('_');
        this.supported_actions = supported_actions;
        this.status = status;

        this.id_onoff_small_ctrl = null;
        this.id_brightness_small_ctrl = null;
    }

    should_be_on(should_be_on) {
        this._request_action(((should_be_on)? '/turn_on' : '/turn_off'));
    }

    set_brightness(brightness_pct) {
        this._request_action('/set_brightness/' + brightness_pct);
    }

    update_status(new_status) {
        console.log("Update lamp status: ", this.name, new_status);

        if (this.id_onoff_small_ctrl) {
            $('#'+this.id_onoff_small_ctrl).prop('checked', new_status.is_on);
        }

        if (this.id_brightness_small_ctrl) {
            $('#'+this.id_onoff_small_ctrl).val(new_status.brightness * 100);
        }
    }

    _request_action(action_url) {
        var url = this.action_base_url + action_url
        var self = this;
        $.when(wget(url)).then(function(thing_status) {
            self.update_status(thing_status);
        });
    }

    get_list_item_ctrl() {
        return $('<li class="lamp_li">')
                        .append(this._onoff_small_ctrl() || "")
                        .append(this._open_panel_ctrl())
                        .append(this._brightness_small_ctrl() || "")
                        .append(this._detailed_panel_ctrl() || "");
    }

    _open_panel_ctrl() {
        var class_name = 'lamp_open_panel_ctrl';
        var element_id = class_name + this.html_id;
        this.id_open_panel_ctrl = element_id;
        var e = $('<a>').text(this.name)
                        .attr('class', class_name)
                        .attr('id', element_id)
                        .attr('href', '#');

        var self = this;
        $(document).on('click', '#'+element_id, function(){ 
            $('#' + self._get_id_detailed_panel_ctrl()).toggle();
        });

        return e;
    }

    _get_id_detailed_panel_ctrl() {
        return 'lamp_detailed_panel_ctrl' + this.html_id;
    }

    _detailed_panel_ctrl() {
        var class_name = 'lamp_detailed_panel_ctrl';
        var element_id = this._get_id_detailed_panel_ctrl();
        this.id_detailed_panel_ctrl = element_id;
        var e = $('<div>').attr('class', class_name)
                          .attr('id', element_id)
                          .css('display', 'none');

        // TODO
        e.append($('<p>').text("HOLA MUNDO"));

        return e;
    }

    _onoff_small_ctrl() {
        if (! this.supported_actions.includes('turn_on')) {
            return null;
        }

        var class_name = 'lamp_is_on_checkbox';
        var element_id = class_name + this.html_id;
        this.id_onoff_small_ctrl = element_id;
        var e = $('<input>').attr('type', 'checkbox')
                            .attr('class', class_name)
                            .attr('id', element_id)
                            .attr('checked', this.status.is_on);

        var self = this;
        $(document).on('click', '#'+element_id, function(){ 
            var state_on = $('#'+element_id).is(':checked');
            self.should_be_on(state_on); 
        });

        return e;
    }

    _brightness_small_ctrl() {
        if (! this.supported_actions.includes('set_brightness')) {
            return null;
        }

        var class_name = 'lamp_set_brightness_slider';
        var element_id = class_name + this.html_id;
        this.id_brightness_small_ctrl = element_id;


        var slider = $('<input>').attr('type', 'range')
                                 .attr('class', class_name + ' form-control-range')
                                 .attr('id', element_id)
                                 .attr('min', 0)
                                 .attr('max', 100)
                                 .attr('value', (this.status.brightness));

        var self = this;
        var cb = function(){ 
            var brightness_pct = $('#'+element_id).val();
            self.set_brightness(brightness_pct); 
        }

        // Click for browsers, touchend for mobile
        $(document).on('click', '#'+element_id, cb);
        $(document).on('touchend', '#'+element_id, cb);

        return slider;
    }
}

class ThingsApp {
    constructor(base_url) {
        this.base_url = base_url;
        this.things = [];
        this.unknown_things= [];

        this.ready = $.Deferred();
        this.things_ready = $.Deferred();
        this.unknown_things_ready = $.Deferred();

        var self = this;

        $.when(self.things_ready).then(function(){
            $.when(self.unknown_things_ready).then(function(){
                self.ready.resolve();
            });
        });

        $.when(wget(this.base_url + "things/get_world_status")).then(function(things) {
            self.things = things;

            self.lamps = [];
            var lamps = self.get_things_of_type('lamp');
            for (var name in lamps) {
                self.lamps.push(new Lamp(self.base_url, name,
                                         lamps[name].supported_actions,
                                         lamps[name].status))
            }

            self.things_ready.resolve();
        });

        $.when(wget(this.base_url + "things/unknown_things")).then(function(things) {
            self.unknown_things = things;
            self.unknown_things_ready.resolve();
        });
    };

    get_things_of_type(type_filter) {
        if (!type_filter) return this.things;

        var things = {}
        for (var thing_name in this.things) {
            var thing = this.things[thing_name];
            if (thing.thing_types.includes(type_filter)) {
                things[thing_name] = thing;
            }
        }

        return things;
    }

    build_lamps_ui(lamps_list_element_id) {
        $.each(this.lamps, function(_, lamp) {
            console.log("Discovered lamp ", lamp);
            $(lamps_list_element_id).append(lamp.get_list_item_ctrl());
        });
    }

    build_media_players_ui(ctrl_id) {
        $.each(this.get_things_of_type('media_player'), function(name, thing) {
            var row = $('<tr>').append($('<td>').text(name));
            $(ctrl_id).append(row);
        });
    }

    build_mqtt_network_status_ui(netstatus_table_id) {
        $.each(this.get_things_of_type('mqtt'), function(name, thing) {
            var row = $('<tr>').append($('<td>').text(name))
                               .append($('<td>').text(thing.status.link_quality || "Unknown"))
                               .append($('<td>').text(thing.status.battery_level || "Unknown"));
            $(netstatus_table_id + ' > tbody:last-child').append(row);
        });
    }
}


//var things_app = new ThingsApp("http://127.0.0.1:2000/");
var things_app = new ThingsApp("/");
$(document).ready(function(){
    $.when(things_app.ready).then(function() {
        things_app.build_lamps_ui('#lamps');
        things_app.build_mqtt_network_status_ui('#networkstatus');
        things_app.build_media_players_ui('#media_players');
    });
});
</script>

</head>

<body>

<div class="container-fluid">
    <h2>Lamps</h2>
    <ul id="lamps"></ul>

    <h2>MQTT Network status</h2>
    <table id="networkstatus">
    <tr>
        <td>Thing</td>
        <td>Link quality</td>
        <td>Battery</td>
    </tr>
    </table>
</div>

</body>

</html>

