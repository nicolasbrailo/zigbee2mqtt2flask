<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

<script>
JSON.stringify = JSON.stringify || function (obj) {
    var t = typeof (obj);
    if (t != "object" || obj === null) {
        // simple data type
        if (t == "string") obj = '"'+obj+'"';
        return String(obj);
    }
    else {
        // recurse array or object
        var n, v, json = [], arr = (obj && obj.constructor == Array);
        for (n in obj) {
            v = obj[n]; t = typeof(v);
            if (t == "string") v = '"'+v+'"';
            else if (t == "object" && v !== null) v = JSON.stringify(v);
            json.push((arr ? "" : '"' + n + '":') + String(v));
        }
        return (arr ? "[" : "{") + String(json) + (arr ? "]" : "}");
    }
};

var wget = function(url) {
    var d = $.Deferred();
    $.ajax({
      type: 'GET',
      dataType: 'json',
      url: url,
      success: function(msg){ d.resolve(msg); },
      error: function(request, server_status, error){ d.resolve(null); },
    });
    return d;
}

class Lamp {
    constructor(things_server_url, name, supported_actions, status) {
        this.action_base_url = things_server_url + 'things/' + name;
        this.name = name;
        // HTML ids can't contain whitespaces
        this.html_id = name.split(' ').join('_');
        this.supported_actions = supported_actions;
        this.status = status;

        this.id_onoff_small_ctrl = null;
        this.id_brightness_small_ctrl = null;
    }

    should_be_on(should_be_on) {
        this._request_action(((should_be_on)? '/turn_on' : '/turn_off'));
    }

    set_brightness(brightness_pct) {
        this._request_action('/set_brightness/' + brightness_pct);
    }

    update_status(new_status) {
        console.log(this.name, new_status);

        if (this.id_onoff_small_ctrl) {
            $('#'+this.id_onoff_small_ctrl).prop('checked', new_status.is_on);
        }

        if (this.id_brightness_small_ctrl) {
            $('#'+this.id_onoff_small_ctrl).val(new_status.brightness * 100);
        }
    }

    _request_action(action_url) {
        var url = this.action_base_url + action_url
        var self = this;
        $.when(wget(url)).then(function(thing_status) {
            self.update_status(thing_status);
        });
    }

    get_list_item_ctrl() {
        var ctrl1 =  this.onoff_small_ctrl() || "";
        var ctrl2 = this.brightness_small_ctrl() || "";
        return $('<li>').append(ctrl1).append(this.name).append(ctrl2);
    }

    onoff_small_ctrl() {
        if (! this.supported_actions.includes('turn_on')) {
            return null;
        }

        var class_name = 'lamp_is_on_checkbox';
        var element_id = class_name + this.html_id;
        this.id_onoff_small_ctrl = element_id;
        var e = $('<input>').attr('type', 'checkbox')
                            .attr('class', class_name)
                            .attr('id', element_id)
                            .attr('checked', this.status.is_on);

        var self = this;
        $(document).on('click', '#'+element_id, function(){ 
            var state_on = $('#'+element_id).is(':checked');
            self.should_be_on(state_on); 
        });

        return e;
    }

    brightness_small_ctrl() {
        if (! this.supported_actions.includes('set_brightness')) {
            return null;
        }

        var class_name = 'lamp_set_brightness_slider';
        var element_id = class_name + this.html_id;
        this.id_brightness_small_ctrl = element_id;
        var e = $('<input>').attr('type', 'range')
                            .attr('class', class_name)
                            .attr('id', element_id)
                            .attr('min', 0)
                            .attr('max', 100)
                            .attr('value', (this.status.brightness*100));

        var self = this;
        $(document).on('click', '#'+element_id, function(){ 
            var brightness_pct = $('#'+element_id).val();
            self.set_brightness(brightness_pct); 
        });

        return e;
    }
}

class ThingsApp {
    constructor(base_url) {
        this.base_url = base_url;
        this.things = [];
        this.unknown_things= [];

        this.ready = $.Deferred();
        this.things_ready = $.Deferred();
        this.unknown_things_ready = $.Deferred();

        var self = this;

        $.when(self.things_ready).then(function(){
            $.when(self.unknown_things_ready).then(function(){
                self.ready.resolve();
            });
        });

        $.when(wget(this.base_url + "things/get_world_status")).then(function(things) {
            self.things = things;

            self.lamps = [];
            var lamps = self.get_things_of_type('lamp');
            for (var name in lamps) {
                self.lamps.push(new Lamp(self.base_url, name,
                                         lamps[name].supported_actions,
                                         lamps[name].status))
            }

            self.things_ready.resolve();
        });

        $.when(wget(this.base_url + "things/unknown_things")).then(function(things) {
            self.unknown_things = things;
            self.unknown_things_ready.resolve();
        });
    };

    get_things_of_type(type_filter) {
        if (!type_filter) return this.things;

        var things = {}
        for (var thing_name in this.things) {
            var thing = this.things[thing_name];
            if (thing.thing_types.includes(type_filter)) {
                things[thing_name] = thing;
            }
        }

        return things;
    }
}


var things_app = new ThingsApp("http://127.0.0.1:2000/");


$(document).ready(function(){
    $.when(things_app.ready).then(function() {
        $.each(things_app.lamps, function(_, lamp) {
            console.log(lamp);
            $('#lamps').append(lamp.get_list_item_ctrl());
        });
    });
});
</script>

</head>

<body>

Lamps
<ul id="lamps">
</ul>
</body>

</html>

